<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangman Challenge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hangman.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="hangman-body">
    <div class="game-wrapper">
        <header class="game-header">
            <h1>ğŸ¯ Hangman Challenge</h1>
            <div class="status-chips">
                <span class="chip">Lives: <strong id="wrong-display"><span id="wrong">{{ wrong }}</span>/6</strong></span>
            </div>
        </header>

        <div class="main-game-area">
            <div id="hangman-visual" class="visual-container">
                <img id="hangman-img" src="{{ url_for('static', filename='hangman/H' ~ wrong ~ '.png') }}" class="hangman-graphic">
                
                </div>

            <div class="word-display-area">
                <h2 id="masked" class="masked-word">{{ masked }}</h2>
                <div class="guess-history">
                    <p>Guessed: <span id="guessed">{{ guessed | join(", ") }}</span></p>
                </div>
            </div>
        </div>

        <div class="action-panel">
            <button id="hint-btn" class="hint-btn" onclick="useHint()">ğŸ’¡ Need a Hint? (Cost 1 Life)</button>
            <div id="hint-box" class="hint-content" style="display:none;"></div>
        </div>

        <div class="game-footer">
            <p class="instruction">âŒ¨ï¸ Type any letter on your keyboard to guess</p>
            <nav class="game-nav">
                <a href="/hangman" onclick="showLoadingScreen('Preparing Game...', 'LLM is choosing of a word and its hint.')">ğŸ” Restart</a>
                <a href="/cloze">ğŸ“ Cloze</a>
                <a href="/learn">ğŸ“– Vocab</a>
                <a href="/">ğŸ  Home</a>
            </nav>
        </div>
    </div>

    <script>
    let gameLocked = false;

    document.addEventListener("keydown", (e) => {
        if (gameLocked || !/^[a-zA-Z]$/.test(e.key)) return;
        makeGuess(e.key.toLowerCase());
    });

    function makeGuess(letter) {
        fetch("/hangman_guess_ajax", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ letter: letter })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) return;
            updateGame(data);
        });
    }

    function updateGame(data) {
        document.getElementById("masked").innerText = data.masked;
        document.getElementById("wrong").innerText = data.wrong;
        document.getElementById("guessed").innerText = data.guessed.join(", ");
        
        // update img
        const img = document.getElementById("hangman-img");
        if(img) img.src = "/static/hangman/H" + data.wrong + ".png";

        if (data.win) {
            gameLocked = true;
            Swal.fire({
                title: 'ğŸ‰ Excellent!',
                text: 'You guessed the word!',
                icon: 'success',
                showConfirmButton: true,
                confirmButtonText: 'Great !',
                confirmButtonColor: '#3498db',
                timer: 5000, // close after 5s
                timerProgressBar: true
            });
        } else if (data.lose) {
            gameLocked = true;
            Swal.fire({
                title: 'ğŸ’€ Game Over',
                text: `The word was: ${data.answer}`,
                icon: 'error',
                showConfirmButton: true,
                confirmButtonText: 'oh no, try again -w-',
                confirmButtonColor: '#3498db',
                timer: 5000, // close after 5s
                timerProgressBar: true
            });
        }
    }

    function useHint() {
        if (gameLocked) return;
        Swal.fire({
            title: 'Use Hint?',
            text: "It will cost 1 life!",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, help!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch("/hangman_hint", {method: "POST"})
                .then(res => res.json())
                .then(data => {
                    if (data.error === "hint_used") {
                        Swal.fire('Oops', 'Hint already used!', 'warning');
                        return;
                    }
                    document.getElementById("hint-box").innerText = data.hint;
                    document.getElementById("hint-box").style.display = "block";
                    updateGame({
                        masked: document.getElementById("masked").innerText,
                        guessed: document.getElementById("guessed").innerText.split(", ").filter(s => s),
                        wrong: data.wrong,
                        win: false,
                        lose: data.lose,
                        answer: data.answer || null
                    });
                });
            }
        });
    }

    function showLoadingScreen(title, text) {
        Swal.fire({
            title: title,
            text: text,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }
    </script>
</body>
</html>
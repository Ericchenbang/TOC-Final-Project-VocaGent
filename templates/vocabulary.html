<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabApp | Learning Mode</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/learn.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    function toggleBox(id) {
        var box = document.getElementById(id);
        box.style.display = (box.style.display !== "block") ? "block" : "none";
    }

    function jumpToAnchor() {
        const anchor = "{{ anchor }}";
        if (anchor) {
            const element = document.getElementById("w_" + anchor);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }
    }

    function showLoadingScreen(title, text) {
        Swal.fire({
            title: title,
            text: text,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // listen to all make sentence form
        const sentenceForms = document.querySelectorAll('.sentence-form');
        sentenceForms.forEach(form => {
            form.onsubmit = function() {
                const word = this.querySelector('input[name="word"]').value;
                showLoadingScreen(
                    'Checking Grammar...', 
                    `LLM is analyzing your sentence for "${word}"...`
                );
            };
        });

        window.addEventListener('pageshow', function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                Swal.close();
            }
        });

        jumpToAnchor();
    });

    </script>
</head>

<body class="split-body">
    <div class="app-container">
        
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Vocabulary</h3>
                <span class="word-count">{{ words|length }} words</span>
            </div>
            <nav class="sidebar-nav">
                {% for w in words %}
                <a href="#w_{{ w.word }}" class="nav-item">
                    <span class="nav-word">{{ w.word }}</span>
                    <span class="nav-pos">{{ w.part_of_speech }}</span>
                </a>
                {% endfor %}
            </nav>
            <div class="sidebar-footer">
                <!--<a href="javascript:history.back()">‚¨Ö Back to Article</a>-->
            
                <a href="/" class="exit-link">üè† Exit Learning</a>
            </div>
        </aside>

        <main class="main-content">
            {% for w in words %}
            <section id="w_{{ w.word }}" class="word-detail-section">
                <div class="word-hero">
                    <h1 class="display-word">{{ w.word }}</h1>
                    <span class="badge-pos">{{ w.part_of_speech }}</span>
                </div>

                <div class="info-card">
                    <label>Translation</label>
                    <p class="translation-text">{{ w["zh-Hant_definition"] }}</p>
                </div>
                <div class="info-card">
                    <label>Standard Example</label>
                    <p class="example-text">"{{ w.example_sentence }}"</p>
                </div>

                <div class="practice-area">
                    <button class="action-toggle-btn" onclick="toggleBox('box_{{ w.word }}')">
                        üñãÔ∏è Practice this word
                    </button>

                    <div id="box_{{ w.word }}" class="interactive-box" 
                         style="display: {% if w.word in feedback %}block{% else %}none{% endif %};">
                        
                        <form action="/check_sentence" method="POST" class="sentence-form">
                            <input type="hidden" name="level" value="{{ level }}">
                            <input type="hidden" name="count" value="{{ words|length }}">
                            <input type="hidden" name="word" value="{{ w.word }}">

                            <label class="input-label">Your sentence:</label>
                            <textarea name="sentence" class="modern-textarea" placeholder="Use '{{ w.word }}' in a sentence..."></textarea>
                            <button type="submit" class="submit-check-btn">Validate Sentence</button>
                        </form>

                        {% if w.word in feedback %}
                        <div class="feedback-result {% if feedback[w.word].is_correct %}correct{% else %}incorrect{% endif %}">
                            <div class="feedback-header">
                                <strong>Result:</strong>
                                <span class="status-icon">{{ "‚úîÔ∏è Correct" if feedback[w.word].is_correct else "‚ùå Review Needed" }}</span>
                            </div>
                            <p class="user-sent">"{{ feedback[w.word].user_sentence }}"</p>
                            <p class="explanation">{{ feedback[w.word].explanation }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </section>
            {% endfor %}

            <footer class="learning-footer">
                <h3>Finished reviewing?</h3>
                <div class="footer-btns">
                    <a href="/cloze" class="footer-btn cloze">üìù Cloze Test</a>
                    <a href="/hangman" class="footer-btn hangman" onclick="showLoadingScreen('Preparing Game...', 'LLM is choosing of a word and its hint.')">üéØ Hangman</a>
                </div>
            </footer>
        </main>
    </div>
</body>
</html>
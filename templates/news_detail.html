<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ article['title'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="content-wrapper article-detail-page">
        
        <div class="back-to-list-link">
             <a href="{{ url_for('news_list', category=category) }}" class="back-link">
                 ‚Üê Back to {{ category | capitalize }} news
             </a>
        </div>

        <article class="reader-container">
            <header class="article-header">
                <h1 class="article-main-title">{{ article['title'] }}</h1>
                <div class="article-metadata">
                     <span class="category-tag">{{ category | capitalize }}</span>
                     <a href="{{ article.link }}" target="_blank" class="source-link">
                         Read Original Article
                     </a>
                </div>
            </header>

            <section class="article-content">
                <p>{{ article['content'] | replace('\n\n', '</p><p>') | safe }}</p> 
            </section>
        </article>

        <hr class="separator">

        <div class="action-bar learning-controls-container">
            <h2 class="form-title">Customize Your Learning</h2>
            
            <form action="{{ url_for('start_learn') }}" method="post" class="learning-form" id="learningForm">
                <input type="hidden" name="category" value="{{ category }}">
                <input type="hidden" name="article_id" value="{{ article.id }}">
                <div class="form-row">
                    <div class="form-group inline-form-group">
                        <label for="cefr-select">CEFR Level:</label>
                        <select id="cefr-select" name="cefr" required>
                            <option value="">-- choose --</option>
                            <option value="A1">A1 (Beginner)</option>
                            <option value="A2">A2 (Elementary)</option>
                            <option value="B1">B1 (Intermediate)</option>
                            <option value="B2">B2 (Upper Intermediate)</option>
                            <option value="C1">C1 (Advanced)</option>
                            <option value="C2">C2 (Proficiency)</option>
                        </select>
                    </div>

                    <div class="form-group inline-form-group">
                        <label for="count-input">Number of words:</label>
                        <input type="number" id="count-input" name="count" min="1" max="30" required value="10" placeholder="10">
                    </div>
                </div>
                
                <button type="submit" class="primary-action-btn large-btn">
                    üë®‚Äçüè´ Start Vocabulary Learning
                </button>
            </form>

            <div class="secondary-actions">
                <form action="/generate_mindmap" method="POST" class="flex-form" id="mindmapForm">
                    <button type="submit" class="outline-btn">üß† Mind Map</button>
                </form>

                <form action="/generate_reading" method="POST" class="flex-form" id="readingForm">
                    <button type="submit" class="outline-btn">üìú Reading Test</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function showLoading(title, html) {
            Swal.fire({
                title: title,
                html: html,
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        const forms = {
            'learningForm': ['Analyzing Article...', 'LLM is selecting key vocabularies and creating examples.'],
            'mindmapForm': ['Mapping Ideas...', 'LLM is breaking down the article into a visual structure.'],
            'readingForm': ['Generating Quiz...', 'LLM is creating personalized questions based on the content.']
        };

        Object.keys(forms).forEach(id => {
            const form = document.getElementById(id);
            if (form) {
                form.onsubmit = function() {
                    showLoading(forms[id][0], forms[id][1]);
                };
            }
        });

        // When back to news, loading should not show on screen
        window.addEventListener('pageshow', function(event) {
            // If persisted is true, means that page is recover form browser bfcache
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                Swal.close(); // close all SweetAlert 
            }
    });
    </script>
</body>
</html>